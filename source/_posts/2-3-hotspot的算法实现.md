---
title: 2.3 hotspot的算法实现
date: 2019-03-31 17:29:19
categories: 
- JVM读书笔记
tags:
- JVM
---
## 枚举根节点

GC的时候所有Java执行线程必须停顿。
**原因**：可达性分析工作必须在一个能保证一致性(系统看起来像冻结在了某个节点)的快照中进行,GC的时候是通过可达性分析进行回收对象的,所以要停顿所有Java线程。
<!--more-->

**OopMap数据结构**：可达性分析从GC Root是 节点找引用链的时候，需要逐个检查这些引用，会消耗很多时间。有了OopMap数据额结构，系统停顿下来后，并不需要一个不漏的检查所有的引用链节点，类加载完成时，HotSpot就把对象内的信息记录到OopMap数据结构中。

## 安全点
HotSpot没有为每一条指令都生成OopMap，只有到了特定的位置才会记录这些信息，这个位置称为安全点。

为了让所有线程在发生GC的时候都跑到安全点上再停下来（为了生成OopMap），有两种方案
* **方案A：抢先式中断**

    <u>不需要线程的执行代码主动去配合，在GC发生时,所有线程全部中断,如果有线程中断的地方没有安全点,那么就恢复线程让他执行到安全点上，目前没有虚拟机采用这种方式</u>

 * **方案B：主动式中断**
    <u>不直接对线程操作，而是设置一个表示，各个线程执行时去主动轮训这个标志，发现中断标志为真时就把自己中断挂起，轮训标志和安全点是重合的，再加上创建对象需要分配内存的地方</u>
    
## 安全区域
程序执行的时候才会进入安全点，中断请求，如果程序不执行（线程处于Sleep或者Blocaked状态），无法相应JVM的中断请求。此时需要安全区域来解决。

安全区域是指在一段代码片段之中，引用关系不会发生变化。在此区域任何地方开始GC都是安全的。可以看成是被扩展的安全点
