---
title: 4.3 JDK的可视化工具
date: 2019-04-01 11:31:46
categories: 
- JVM读书笔记
tags:
- 可视化工具
---
## JConsole:Java监视与管理控制台


JConsole(Java monitoring and Management Console)是一种基于JMX的可视化监视管理工具。它管理部分的功能是针对JMX MBean进行管理，由于MBean可以使用代码，中间件服务器的管理控制台或者所有符合JMX规范的软件进行访问。 
<!--more-->
### **1. 启动JConsole:**
通过JDK/bin目录下的"jconsole.exe" 启动JConsole后,将自动搜多出所有虚拟机进程


### **2.内存监控:** 
用于监视收集器管理的虚拟机内存（Java堆和永久代）的变化趋势（相当于jstat）。JConsole监视的代码，如下：



通过JConsole监视，在“内存”页签中可以看到内存池Eden区的运行趋势呈现折线状。而监视范围扩大至整个堆后，会发现曲线是一条向上增长的平滑曲线。并且从柱状图可以看出，在1000次循环执行结束，运行了System.gc()后，虽然整个新生代Eden和Survivor区都基本清空了，但是代表老年代的柱状图仍然保持峰值状态，说明被填充进堆中的数据在System.gc()方法执行之后仍然存活。




* **问题**：为何执行了System.gc()之后，老年代的柱状图仍然显示峰值状态，代码需要如何调整才能让System.gc()回收掉填充到堆中的对象？ 
* **答案**：执行System.gc()时，空间未能回收是因为List<OOMObject> list对象仍然存活，fillHeap()方法仍然没有退出，因此list对象在System.gc()执行时仍然处于作用域中。如果把System.gc()移动到fillHeap()方法外调用就可以回收掉全部内存。
* **注意：准确的说，只有在虚拟机使用解释器执行的时候，“在作用域之内”才能保证它不会被回收，因为这里的回收还涉及局部变量表Slot复用，即时编译介入时机等问题。**




### **3 线程监控** :
用于线程停顿时可以使用此进行监控（相当于jstack),遇到线程停顿时可以使用这个页签进行监控分析。
**线程长时间停顿的主要原因有：**

> * 等待外部资源(数据库连接、网络资源、设备资源等)



> * 死循环



> * 锁等待（活锁和死锁）





## VisualVM：多合一故障处理工具

**Visual VM（All-in One Java Troubleshooting Tool)** 是到目前为止随JDK发布的功能最强大的运行监视和故障处理程序。
* **功能：** 
> 包括：运行监视，故障处理，性能分析等。而且Visual VM的还有一个很大的优点：不需要被监视的程序基于特殊Agent运行，因此它对应用程序的实际性能的影响很小，使得它可以直接应用在生产环境中。

### 1.VisualVM 兼容范围与插件安装
VisualVM基于NetBeans平台，因此她具备了插件扩展功能的特性，通过插件扩展支持，VisualVM可以做到：
* 1 虚拟机进程已经进程的配置、环境信息（jps、jinfo)
* 2 监视应用程序的CPU、GC、堆、方法区以及线程的信息（jstat、jstack）
* 3 dump以及分析堆转储快照（jmap、jstack）。
* 4 方法级的程序运行新更能分析，找出被调用最多、运行时间最长的方法。
* 5 离线程序快照:手机程序的运行时配置、线程dump、内存dump等信息建立一个快照，可以将快照发送开发者进行Bug反馈。
* 6 其他plugins的无限可能性




### 2.生成、浏览堆转储快照




### 3.分析程序性能

> 要开始分析,选择CPU和内存按钮中的一个,然后切换到应用程序中堆程序进行操作,VisualVM会记录到这段时间中应用程序执行过的方法。会将统计每个方法的执行次数、执行消耗；


### 4 BTrace动态日志跟踪
> BTrace是一个VisualVM插件，作用是在不停止目标程序运行的前提下,通过HotSpot虚拟机的HotSwap技术动态加入原本并不存在的调试代码,通过调试增量来加入日志代码以解决问题。BTrace打印调用堆栈、参数、返回值只是最基础的应用，在它的网站上有使用BTrace进行性能监视、定位链接侧漏和内存侧漏、解决多线程竞争问题等例子。









